<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è…¦ç­‹æ€¥è½‰å½</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <div class="app">

    <!-- é–‹å§‹ç•«é¢ -->
    <div id="startScreen">
      <div class="cover-wrap">
        <img src="cover.jpg" class="cover" alt="ç™¾è¬å°å­¸å ‚">

        <div class="name-wrap">
          <input id="nameInput" class="name-input" placeholder="è¼¸å…¥æ‚¨çš„é“è™Ÿ" />
          <div id="nameHint" class="name-hint"></div>
        </div>

        <button id="startBtn" class="start-on-cover">é–‹å§‹æŒ‘æˆ°</button>

        <!-- âœ… æ–°å¢ï¼šé–‹å§‹é çš„æ’è¡Œæ¦œæŒ‰éˆ• -->
        <button id="rankBtn" class="start-on-cover" style="margin-top:12px; opacity:.95;">
          æŸ¥çœ‹æ’è¡Œæ¦œ
        </button>
      </div>
    </div>

    <!-- éŠæˆ²ç•«é¢ -->
    <div id="gameScreen" style="display:none;">
      <div class="card">
        <p id="question"></p>
        <div id="choices"></div>
        <p id="result"></p>
        <p id="score"></p>
      </div>
    </div>

    <!-- æ’è¡Œæ¦œ -->
    <div id="rankScreen" style="display:none;">
      <div class="card">
        <h2>ğŸ† æ’è¡Œæ¦œ</h2>
        <ol id="rankList"></ol>

        <button id="restartBtn">å†ç©ä¸€æ¬¡</button>

        <!-- âœ… æ–°å¢ï¼šæ’è¡Œæ¦œè¿”å›é¦–é  -->
        <button id="backHomeBtn">è¿”å›é¦–é </button>
      </div>
    </div>

  </div>

<script>
/* ========= 0) é›²ç«¯æ’è¡Œæ¦œï¼ˆWorkersï¼‰ ========= */
const RANK_API = "https://quiz-rank-api.ms0469137.workers.dev";
const RANK_TOKEN = "taiching2026";

/* ========= 1) é¡Œåº«ï¼ˆJSON è¼‰å…¥ï¼‰ ========= */
let questions = [];
let current = 0;
let score = 0;

/* ========= 2) ç•«é¢å…ƒç´  ========= */
const startBtn    = document.getElementById("startBtn");
const startScreen = document.getElementById("startScreen");
const gameScreen  = document.getElementById("gameScreen");

const questionEl = document.getElementById("question");
const choicesEl  = document.getElementById("choices");
const resultEl   = document.getElementById("result");
const scoreEl    = document.getElementById("score");

const rankScreen = document.getElementById("rankScreen");
const rankList   = document.getElementById("rankList");
const restartBtn = document.getElementById("restartBtn");

const nameInput = document.getElementById("nameInput");
const nameHint  = document.getElementById("nameHint");

const rankBtn = document.getElementById("rankBtn");         // âœ… æ–°å¢
const backHomeBtn = document.getElementById("backHomeBtn"); // âœ… æ–°å¢

let cardEl = null;

/* ========= 3) éŸ³æ•ˆ ========= */
let audioCtx;
function beep(type){
  try{
    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const ctx = audioCtx;
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.connect(g); g.connect(ctx.destination);

    const ok = type === "ok";
    o.type = ok ? "triangle" : "sine";
    o.frequency.value = ok ? 880 : 180;

    const now = ctx.currentTime;
    g.gain.setValueAtTime(0.0001, now);
    g.gain.exponentialRampToValueAtTime(ok ? 0.22 : 0.28, now + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, now + (ok ? 0.14 : 0.18));

    o.start(now);
    o.stop(now + (ok ? 0.16 : 0.20));
  }catch(e){}
}

/* ========= 4) é›²ç«¯æ’è¡Œæ¦œï¼ˆWorkers APIï¼‰ ========= */
async function saveToRank(name, score){
  try{
    const url = `${RANK_API}/?action=add&name=${encodeURIComponent(name)}&score=${encodeURIComponent(score)}&token=${encodeURIComponent(RANK_TOKEN)}&t=${Date.now()}`;
    const res = await fetch(url, { cache: "no-store" });
    const data = await res.json();
    console.log("saveToRank:", data);
  }catch(e){
    console.log("saveToRank failed:", e);
  }
}

async function showRank(){
  rankList.innerHTML = "<li>è¼‰å…¥ä¸­...</li>";
  try{
    const url = `${RANK_API}/?action=list&t=${Date.now()}`;
    const res = await fetch(url, { cache: "no-store" });
    const data = await res.json();

    rankList.innerHTML = "";
    if (!Array.isArray(data) || data.length === 0) {
      rankList.innerHTML = "<li>ç›®å‰é‚„æ²’æœ‰ç´€éŒ„</li>";
      return;
    }

    data.forEach((item) => {
      const li = document.createElement("li");
      li.textContent = `${item.name} â€” ${item.score} åˆ†`;
      rankList.appendChild(li);
    });
  }catch(e){
    rankList.innerHTML = "<li>æ’è¡Œæ¦œè¼‰å…¥å¤±æ•—</li>";
  }
}

/* ========= 5) å‡ºé¡Œ ========= */
function showQuestion(){
  const q = questions[current];

  if (!q) {
    const name = localStorage.getItem("player_name") || "åŒ¿å";

    (async () => {
      await saveToRank(name, score);
      gameScreen.style.display = "none";
      rankScreen.style.display = "block";
      await showRank();
    })();

    return;
  }

  questionEl.textContent = q.question;
  choicesEl.innerHTML = "";
  resultEl.textContent = "";
  resultEl.className = "";
  scoreEl.textContent = `ç›®å‰åˆ†æ•¸ï¼š${score}`;

  q.choices.forEach((text, i) => {
    const btn = document.createElement("button");
    btn.textContent = text;
    btn.onclick = () => answer(i);
    choicesEl.appendChild(btn);
  });
}

/* ========= 6) ä½œç­” ========= */
function answer(i){
  const q = questions[current];
  document.querySelectorAll("#choices button").forEach(b => b.classList.add("locked"));

  if (i === q.answer) {
    resultEl.textContent = "âœ… ç­”å°äº†ï¼";
    resultEl.className = "ok";
    beep("ok");

    if (cardEl) {
      cardEl.classList.remove("flash-gold","pop-ok","shake-bad");
      void cardEl.offsetWidth;
      cardEl.classList.add("flash-gold","pop-ok");
      setTimeout(()=>cardEl.classList.remove("flash-gold","pop-ok"), 600);
    }
    score++;
  } else {
    resultEl.textContent = "âŒ ç­”éŒ¯äº†";
    resultEl.className = "bad";
    beep("bad");

    if (cardEl) {
      cardEl.classList.remove("flash-gold","pop-ok","shake-bad");
      void cardEl.offsetWidth;
      cardEl.classList.add("shake-bad");
      setTimeout(()=>cardEl.classList.remove("shake-bad"), 400);
    }
  }

  current++;
  setTimeout(showQuestion, 350);
}

/* ========= 7) è¼‰å…¥é¡Œåº« ========= */
async function loadQuestions(){
  try{
    const res = await fetch("./questions.json", { cache: "no-store" });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    if (!Array.isArray(data) || data.length === 0) throw new Error("é¡Œåº«æ ¼å¼éŒ¯èª¤æˆ–ç‚ºç©º");
    questions = data;
    return true;
  }catch(err){
    console.error("é¡Œåº«è¼‰å…¥å¤±æ•—ï¼š", err);
    alert("é¡Œåº«è¼‰å…¥å¤±æ•—ï¼šè«‹ç¢ºèª questions.json æ˜¯å¦å­˜åœ¨ä¸”æ ¼å¼æ­£ç¢ºï¼Œä¸”ä½ æ˜¯ç”¨ GitHub Pages é–‹å•Ÿï¼ˆä¸æ˜¯ file://ï¼‰ã€‚");
    return false;
  }
}

/* ========= 8) é–‹å§‹ / é‡ä¾† / çœ‹æ¦œ / è¿”å› ========= */
startBtn.addEventListener("click", async () => {
  const name = nameInput.value.trim();
  if (!name) {
    nameHint.textContent = "è«‹å…ˆè¼¸å…¥é“è™Ÿ";
    return;
  }
  nameHint.textContent = "";
  localStorage.setItem("player_name", name);

  const ok = await loadQuestions();
  if (!ok) return;

  startScreen.style.display = "none";
  rankScreen.style.display = "none";
  gameScreen.style.display = "block";

  cardEl = gameScreen.querySelector(".card");

  current = 0;
  score = 0;

  showQuestion();
});

restartBtn.addEventListener("click", () => {
  rankScreen.style.display = "none";
  startScreen.style.display = "block";
});

// âœ… é–‹å§‹é  â†’ çœ‹æ’è¡Œæ¦œï¼ˆä¸éœ€è¦å…ˆç©ï¼‰
rankBtn.addEventListener("click", async () => {
  startScreen.style.display = "none";
  gameScreen.style.display = "none";
  rankScreen.style.display = "block";
  await showRank();
});

// âœ… æ’è¡Œæ¦œ â†’ è¿”å›é¦–é 
backHomeBtn.addEventListener("click", () => {
  rankScreen.style.display = "none";
  gameScreen.style.display = "none";
  startScreen.style.display = "block";
});

// å¸¶å›å·²å­˜é“è™Ÿ
const savedName = localStorage.getItem("player_name");
if (savedName) nameInput.value = savedName;
</script>

</body>
</html>
