<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>å¤ªæ¸…è§€ç™¾è¬å°å­¸å ‚</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <div class="app">

    <!-- é–‹å§‹ç•«é¢ -->
    <div id="startScreen">
      <div class="cover-wrap">
        <img src="cover.jpg" class="cover" alt="ç™¾è¬å°å­¸å ‚">

        <div class="name-wrap">
          <input id="nameInput" class="name-input" placeholder="è¼¸å…¥æ‚¨çš„é“è™Ÿ" />
          <div id="nameHint" class="name-hint"></div>
        </div>

        <button id="startBtn" class="start-on-cover">é–‹å§‹æŒ‘æˆ°</button>
      </div>
    </div>

    <!-- éŠæˆ²ç•«é¢ -->
    <div id="gameScreen" style="display:none;">
      <div class="card">
        <p id="question"></p>
        <div id="choices"></div>
        <p id="result"></p>
        <p id="score"></p>
      </div>
    </div>

    <!-- æ’è¡Œæ¦œ -->
    <div id="rankScreen" style="display:none;">
      <div class="card">
        <h2>ğŸ† æ’è¡Œæ¦œ</h2>
        <ol id="rankList"></ol>
        <button id="restartBtn">å†ç©ä¸€æ¬¡</button>
      </div>
    </div>

  </div>

<script>
/* ======================
   â‘  é¡Œåº«ï¼ˆæ”¹æˆ JSON è¼‰å…¥ï¼‰
====================== */
let questions = [];   // â† æ³¨æ„ï¼šè®Šæˆ letï¼Œç­‰ fetch å¾Œæ‰æœ‰è³‡æ–™
let current = 0;
let score = 0;

/* ======================
   â‘¡ ç•«é¢å…ƒç´ 
====================== */
const startBtn    = document.getElementById("startBtn");
const startScreen = document.getElementById("startScreen");
const gameScreen  = document.getElementById("gameScreen");

const questionEl = document.getElementById("question");
const choicesEl  = document.getElementById("choices");
const resultEl   = document.getElementById("result");
const scoreEl    = document.getElementById("score");

const rankScreen = document.getElementById("rankScreen");
const rankList   = document.getElementById("rankList");
const restartBtn = document.getElementById("restartBtn");

const nameInput = document.getElementById("nameInput");
const nameHint  = document.getElementById("nameHint");

let cardEl = null;

/* ======================
   â‘¢ éŸ³æ•ˆ
====================== */
let audioCtx;
function beep(type){
  try{
    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const ctx = audioCtx;
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.connect(g); g.connect(ctx.destination);

    const ok = type === "ok";
    o.type = ok ? "triangle" : "sine";
    o.frequency.value = ok ? 880 : 180;

    const now = ctx.currentTime;
    g.gain.setValueAtTime(0.0001, now);
    g.gain.exponentialRampToValueAtTime(ok ? 0.22 : 0.28, now + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, now + (ok ? 0.14 : 0.18));

    o.start(now);
    o.stop(now + (ok ? 0.16 : 0.20));
  }catch(e){}
}

/* ======================
   â‘£ æ’è¡Œæ¦œï¼ˆæœ¬æ©Ÿï¼‰
====================== */
function saveToRank(name, score) {
  const key = "quiz_rank";
  const data = JSON.parse(localStorage.getItem(key) || "[]");
  data.push({ name, score, time: Date.now() });
  data.sort((a, b) => b.score - a.score);
  localStorage.setItem(key, JSON.stringify(data.slice(0, 10)));
}

function showRank() {
  const data = JSON.parse(localStorage.getItem("quiz_rank") || "[]");
  rankList.innerHTML = "";

  if (data.length === 0) {
    rankList.innerHTML = "<li>ç›®å‰é‚„æ²’æœ‰ç´€éŒ„</li>";
    return;
  }

  data.forEach((item, i) => {
    const li = document.createElement("li");
    // âœ… ç”¨ <ol> è‡ªå‹•ç·¨è™Ÿï¼Œæ‰€ä»¥é€™è£¡ä¸è¦å†åŠ  i+1
    li.textContent = `${item.name} â€” ${item.score} åˆ†`;
    rankList.appendChild(li);
  });
}

/* ======================
   â‘¤ å‡ºé¡Œ
====================== */
function showQuestion() {
  const q = questions[current];

  // é¡Œç›®çµæŸ â†’ æ’è¡Œæ¦œ
  if (!q) {
    const name = localStorage.getItem("player_name") || "åŒ¿å";
    saveToRank(name, score);

    gameScreen.style.display = "none";
    rankScreen.style.display = "block";
    showRank();
    return;
  }

  questionEl.textContent = q.question;
  choicesEl.innerHTML = "";
  resultEl.textContent = "";
  resultEl.className = "";
  scoreEl.textContent = `ç›®å‰åˆ†æ•¸ï¼š${score}`;

  q.choices.forEach((text, i) => {
    const btn = document.createElement("button");
    btn.textContent = text;
    btn.onclick = () => answer(i);
    choicesEl.appendChild(btn);
  });
}

/* ======================
   â‘¥ ä½œç­”
====================== */
function answer(i) {
  const q = questions[current];

  document.querySelectorAll("#choices button").forEach(b => b.classList.add("locked"));

  if (i === q.answer) {
    resultEl.textContent = "âœ… ç­”å°äº†ï¼";
    resultEl.className = "ok";
    beep("ok");

    if (cardEl) {
      cardEl.classList.remove("flash-gold","pop-ok","shake-bad");
      void cardEl.offsetWidth;
      cardEl.classList.add("flash-gold","pop-ok");
      setTimeout(()=>cardEl.classList.remove("flash-gold","pop-ok"), 600);
    }

    score++;
  } else {
    resultEl.textContent = "âŒ ç­”éŒ¯äº†";
    resultEl.className = "bad";
    beep("bad");

    if (cardEl) {
      cardEl.classList.remove("flash-gold","pop-ok","shake-bad");
      void cardEl.offsetWidth;
      cardEl.classList.add("shake-bad");
      setTimeout(()=>cardEl.classList.remove("shake-bad"), 400);
    }
  }

  current++;
  setTimeout(showQuestion, 350);
}

/* ======================
   â‘¦ è¼‰å…¥é¡Œåº«ï¼ˆé‡è¦ï¼‰
====================== */
async function loadQuestions(){
  try{
    const res = await fetch("./questions.json", { cache: "no-store" });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();

    // åŸºæœ¬æª¢æŸ¥ï¼ˆé¿å… JSON å£æ‰ï¼‰
    if (!Array.isArray(data) || data.length === 0) throw new Error("é¡Œåº«æ ¼å¼éŒ¯èª¤æˆ–ç‚ºç©º");

    questions = data;
    return true;
  }catch(err){
    console.error("é¡Œåº«è¼‰å…¥å¤±æ•—ï¼š", err);
    alert("é¡Œåº«è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºèª questions.json æ˜¯å¦å­˜åœ¨ä¸”æ ¼å¼æ­£ç¢ºã€‚");
    return false;
  }
}

/* ======================
   â‘§ é–‹å§‹ / é‡ä¾†
====================== */
startBtn.addEventListener("click", async () => {
  const name = nameInput.value.trim();
  if (!name) {
    nameHint.textContent = "è«‹å…ˆè¼¸å…¥é“è™Ÿ";
    return;
  }
  nameHint.textContent = "";
  localStorage.setItem("player_name", name);

  // æ¯æ¬¡é–‹å§‹éƒ½é‡æ–°è¼‰å…¥é¡Œåº«ï¼ˆç¢ºä¿ä½ æ›´æ–° JSON å¾Œèƒ½åƒåˆ°ï¼‰
  const ok = await loadQuestions();
  if (!ok) return;

  startScreen.style.display = "none";
  rankScreen.style.display = "none";
  gameScreen.style.display = "block";

  cardEl = gameScreen.querySelector(".card");

  current = 0;
  score = 0;

  showQuestion();
});

restartBtn.addEventListener("click", () => {
  rankScreen.style.display = "none";
  startScreen.style.display = "block";
});

// é€²ä¾†å…ˆæŠŠå·²å­˜çš„é“è™Ÿå¸¶å›è¼¸å…¥æ¡†ï¼ˆæ–¹ä¾¿é‡ç©ï¼‰
const savedName = localStorage.getItem("player_name");
if (savedName) nameInput.value = savedName;
</script>


</body>
</html>
